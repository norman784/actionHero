!function(exports){var actionHeroWebSocket=function(options,callback){var self=this;null==callback&&"function"==typeof options&&(callback=options,options=null),self.messageCount=0,self.callbacks={},self.id=null,self.events={},self.options=self.defaults();for(var i in options)self.options[i]=options[i];self.faye=options&&null!=options.faye?options.faye:null!=window.Faye?window.Faye:Faye};actionHeroWebSocket.prototype.defaults=function(){var host;return"undefined"!=typeof window&&(host=window.location.origin),{host:host,path:"/faye",setupChannel:"/_welcome",channelPrefix:"/client/websocket/connection/",apiPath:"/api",connectionDelay:100}},actionHeroWebSocket.prototype.log=function(message){if(console&&console.log){"string"!=typeof message&&(message=JSON.stringify(message));var date=new Date,times=[date.getHours().toString(),date.getMinutes().toString(),date.getSeconds().toString()];for(var i in times)times[i].length<2&&(times[i]="0"+times[i]);console.log("[AH::client @ "+times.join(":")+"] "+message)}},actionHeroWebSocket.prototype.connect=function(callback){var self=this;self.startupCallback=callback,self.client=new self.faye.Client(self.options.host+self.options.path),self.setupConnection(function(){"function"==typeof self.events.connect&&self.events.connect("connected"),self.client.bind("transport:down",function(){"function"==typeof self.events.disconnect&&self.events.disconnect("disconnected")}),self.client.bind("transport:up",function(){self.messageCount=0,self.setupConnection(function(){"function"==typeof self.events.reconnect&&self.events.reconnect("reconnected")})})})},actionHeroWebSocket.prototype.setupConnection=function(callback){var self=this;setTimeout(function(){var initialMessage=self.client.publish(self.options.setupChannel,"hello");initialMessage.callback(function(){self.id=self.createUUID(),self.channel=self.options.channelPrefix+self.id,self.subscription=self.client.subscribe(self.channel,function(message){self.handleMessage(message)}),setTimeout(function(){self.detailsView(function(details){null!=self.room&&self.send({event:"roomChange",room:self.room}),self.completeConnect(details),callback()})},self.options.connectionDelay)}),initialMessage.errback(function(error){callback(error,null)})},self.options.connectionDelay)},actionHeroWebSocket.prototype.completeConnect=function(details){var self=this;"function"==typeof self.startupCallback&&(self.startupCallback(null,details),delete self.startupCallback)},actionHeroWebSocket.prototype.send=function(args,callback){var self=this;"function"==typeof callback&&(self.messageCount++,self.callbacks[self.messageCount]=callback),self.client.publish(self.channel,args).errback(function(err){self.log(err)})},actionHeroWebSocket.prototype.handleMessage=function(message){var self=this;"response"===message.context?("function"==typeof self.callbacks[message.messageCount]&&self.callbacks[message.messageCount](message),delete self.callbacks[message.messageCount]):"user"===message.context?"function"==typeof self.events.say&&self.events.say(message):null!=message.welcome&&"api"==message.context?(self.welcomeMessage=message.welcome,"function"==typeof self.events.say&&"function"==typeof self.events.welcome&&self.events.welcome(message)):"function"==typeof self.events.alert&&self.events.alert(message)},actionHeroWebSocket.prototype.createUUID=function(){for(var s=[],hexDigits="0123456789abcdef",i=0;36>i;i++)s[i]=hexDigits.substr(Math.floor(16*Math.random()),1);s[14]="4",s[19]=hexDigits.substr(8|3&s[19],1),s[8]=s[13]=s[18]=s[23]="-";var uuid=s.join("");return uuid},actionHeroWebSocket.prototype.action=function(action,params,callback){null==callback&&"function"==typeof params&&(callback=params,params=null),null==params&&(params={}),params.action=action,this.send({event:"action",params:params},callback)},actionHeroWebSocket.prototype.say=function(message,callback){this.send({event:"say",message:message},callback)},actionHeroWebSocket.prototype.detailsView=function(callback){this.send({event:"detailsView"},callback)},actionHeroWebSocket.prototype.roomView=function(callback){this.send({event:"roomView"},callback)},actionHeroWebSocket.prototype.roomChange=function(room,callback){this.room=room,this.send({event:"roomChange",room:room},callback)},actionHeroWebSocket.prototype.listenToRoom=function(room,callback){this.send({event:"listenToRoom",room:room},callback)},actionHeroWebSocket.prototype.silenceRoom=function(room,callback){this.send({event:"silenceRoom",room:room},callback)},actionHeroWebSocket.prototype.documentation=function(callback){this.send({event:"documentation"},callback)},actionHeroWebSocket.prototype.disconnect=function(){this.client.disconnect()},exports.actionHeroWebSocket=actionHeroWebSocket}("undefined"==typeof exports?window:exports);